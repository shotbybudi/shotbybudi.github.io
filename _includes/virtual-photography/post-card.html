{%- comment -%} Default Styles {%- endcomment -%}
{%- assign card_style  = '' -%}
{%- assign text_style  = 'text-themed' -%}
{%- assign badge_style = 'badge-dark' -%}

{%- comment -%} Update Styles {%- endcomment -%}
{%- if post.style == 'fill' -%}
  {%- assign card_style = post.color | prepend: 'bg-' -%}
  {%- if post.color != 'light' -%}
    {%- assign text_style  = 'text-white' -%}
    {%- assign badge_style = 'badge-light text-' -%}
    {%- assign badge_style = badge_style | append: post.color -%}
  {%- endif -%}
{%- else -%}
  {%- assign card_style = post.color | prepend: 'border border-' -%}
  {%- if post.color -%}
    {%- assign badge_style =  post.color | prepend: 'badge-' -%}
  {%- endif -%}
{%- endif -%}

{%- comment -%} Determine Post URL {%- endcomment -%}
{%- if post.external_url -%}
  {%- assign post_url = post.external_url -%}
{%- else -%}
  {%- assign post_url = post.url | relative_url -%}
{%- endif -%}
   
<style>
  :root {
    --card-title-light: #dce0e8;
    --card-title-dark: #cdd6f4;
  }

  [data-theme='light'] {
    --card-title-color: var(--card-title-light);
  }

  [data-theme='dark'] {
    --card-title-color: var(--card-title-dark);
  }

  .card-title {
    color: var(--card-title-color);
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    margin: 0;
    position: relative;
    z-index: 3;
    font-weight: 600; 
  }

  .vp.card {
    border-radius: 12px;
    border: none !important;
    overflow: hidden;
    background-color: transparent !important; /* Prevent white background bleed */
    transition: transform 0.3s ease;
    transform: translateZ(0); /* Fix sub-pixel rendering artifacts */
    -webkit-mask-image: -webkit-radial-gradient(white, black); /* Force clipping in WebKit */
    backface-visibility: hidden; /* Fix rendering artifacts */
  }

  .vp.card img {
    border-radius: 0 !important; /* Let parent clip the image */
  }

  .vp.card:hover {
    transform: translateY(-5px);
  }

  .card-img-overlay {
    /* border-radius removed to avoid double clipping artifacts */
    object-fit: cover;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: flex-start;
    padding: 1.5rem;
  }

  /* Gradient Layer - Top, Black Default */
  .card-img-overlay::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 70%; /* Gradient depth */
    background: linear-gradient(to bottom, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.5) 40%, transparent 100%);
    pointer-events: none;
    z-index: 1;
    transition: opacity 0.4s ease;
    opacity: 1;
  }

  /* Gradient Layer - Hover, Primary */
  .card-img-overlay::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 70%; /* Gradient depth */
    background: linear-gradient(to bottom, rgba(var(--primary-rgb), 0.25) 0%, rgba(var(--primary-rgb), 0.1) 40%, transparent 100%);
    pointer-events: none;
    z-index: 1;
    transition: opacity 0.4s ease;
    opacity: 0;
  }

  .vp.card:hover .card-img-overlay::after {
    opacity: 1;
  }
  
  .vp.card:hover .card-img-overlay::before {
    opacity: 0;
  }
  
  .card-meta {
    z-index: 3;
    position: relative;
    margin-top: 0.75rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
  }
  
  .card-meta .badge {
    font-weight: 500;
    opacity: 0.9;
    background-color: #2c2d3d;
  }

</style>

{%- assign card_data = site.data.virtual-photography[post.slug][post.card-image] -%}
{%- assign card_url = card_data.url -%}

<div class="col-lg-4 col-md-6 col-sm-12 my-3 wow animated fadeIn" data-wow-delay=".15s">
  <a href="{{ post_url }}" class="vp card text-themed" {%- if post.external_url and site.open_new_tab -%} target="_blank" {%- endif -%} style="overflow: hidden;">
    <img loading="lazy" src="{{ card_url }}" alt="{{ post.title }}" class="card-img-top" data-offset-x="{{ post.card-offset-x | default: 50 }}" data-offset-y="{{ post.card-offset | default: 50 }}" data-zoom="{{ post.card-zoom | default: 100 | divided_by: 100.0 }}" style="height: 550px; object-fit: cover; width: 100%;">
    <div class="card-img-overlay">
      <h3 class="card-title">{{ post.title }}</h3>
      
      {% if site.virtual_photography.show_tags and post.tags.size > 0 %}
      <div class="card-meta">
            {% for tag in post.tags %}
              <span class="badge badge-dark">{{ tag }}</span>
            {% endfor %}
      </div>
      {% endif %}

      {% if site.virtual_photography.show_date %}
      <div class="card-date mt-2" style="z-index: 3; position: relative;">
           <span style="color: var(--card-title-color); font-size: 0.85rem; font-weight: 500; text-shadow: 0 2px 4px rgba(0,0,0,0.5); opacity: 0.9;">{{ post.date | date: "%d %B %Y" }}</span>
      </div>
      {% endif %}
      
    </div>
  </a>
  <script>
    (function(){
      var imgs = document.querySelectorAll('.vp.card .card-img-top');
      imgs.forEach(function(img){
        var ox = img.getAttribute('data-offset-x') || '50';
        var oy = img.getAttribute('data-offset-y') || '50';
        var zoom = parseFloat(img.getAttribute('data-zoom') || '1');
        // Slightly increase scale to cover sub-pixel anti-aliasing artifacts at corners
        var scale = zoom * 1.01;
        img.style.objectPosition = ox + '% ' + oy + '%';
        img.style.transform = 'scale(' + scale + ')';
        img.style.transformOrigin = ox + '% ' + oy + '%';
      });
    })();
  </script>
</div>
